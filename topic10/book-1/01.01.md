# Set up

We will continue to develop an API for the MovieDB that will be able to drive the React App you completed in the labs. 


- Use Postman to check a few of the endpoints:

![Get Movies](./img/movies1.png)

![Get a Movies](./img/movies2.png)

Once it's up and running, we can now add a User to the API and persist using MongoDB and Mongoose

## DockerFile

![Mongoose](./img/download.png)

You can need to create a MongoDB. We will do this using another Docker Container and Docker Compose. 

### DockerFile

This uses the same base container as the previous lab. We also need to add some Mongo command Line tools in the App container. This will allow us to check the DB from VS Code

~~~dockerfile
FROM node:18

# Install basic development tools
RUN apt update && apt install -y less man-db sudo

# Ensure default `node` user has access to `sudo`
ARG USERNAME=node
RUN echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

# Install MongoDB command line tools - though mongo-database-tools not available on arm64
ARG MONGO_TOOLS_VERSION=6.0
RUN . /etc/os-release \
    && curl -sSL "https://www.mongodb.org/static/pgp/server-${MONGO_TOOLS_VERSION}.asc" | gpg --dearmor > /usr/share/keyrings/mongodb-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/mongodb-archive-keyring.gpg] http://repo.mongodb.org/apt/debian ${VERSION_CODENAME}/mongodb-org/${MONGO_TOOLS_VERSION} main" | tee /etc/apt/sources.list.d/mongodb-org-${MONGO_TOOLS_VERSION}.list \
    && apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get install -y mongodb-mongosh \
    && if [ "$(dpkg --print-architecture)" = "amd64" ]; then apt-get install -y mongodb-database-tools; fi \
    && apt-get clean -y && rm -rf /var/lib/apt/lists/*

# Set `DEVCONTAINER` environment variable to help with orientation
ENV DEVCONTAINER=true
~~~



### DockerCompose

Docker Compose allows us to "compose" two different containers; one for the express app and another for the MongoDB. The

~~~dockerfile
version: '3.8'

services:
  app:
    build: 
      context: .
      dockerfile: DockerFile
    volumes:
      - ../..:/workspaces:cached

    # Overrides default command so things don't shut down after the process ends.
    command: sleep infinity

    # Runs app on the same network as the database container, allows "forwardPorts" in devcontainer.json function.
    network_mode: service:db

    # Use "forwardPorts" in **devcontainer.json** to forward an app port locally. 
    # (Adding the "ports" property to this file will not forward from a Codespace.)

  db:
    image: mongo:latest
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db

volumes:
  mongodb-data:
~~~



### .devcontainer

~~~dockerfile
{
	"name": "ewd-labs-2023",
	"dockerComposeFile": "docker-compose.yml",
	"service": "app",
	"workspaceFolder": "/workspaces/${localWorkspaceFolderBasename}",
	"remoteUser": "node"
}
~~~

