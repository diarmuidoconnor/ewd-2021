# Add Passport Authentication

Passport strategies are a middleware functions that a requests runs through before getting to the actual route.â€‹ You will now create a JWT strategy and add it to the /api/movies route.

+ In /src/accounts/services/index.js, add the following function:

~~~javascript
///... Code as before 
verifyToken:   async (token,accountsRepository, tokenManager) => {
    const decoded = await tokenManager.decode(token);
    const user = await accountsRepository.getByEmail(decoded.email);
    if (!user) {
        throw new Error('Bad token');
    }
    return user.email;
}
///... Code as before 
~~~

The above script extracts the user email from the token and verifies it is a valid account email. The *user id* is then passed on to the next middleware, accessible through the request object.



+ Open src/accounts/controllers/index.js and add the following:

~~~javascript
//... code as before
    const verifyToken = async (request, response, next) => {
        try { 
        // Input
        const authHeader = request.headers.authorization;

        // Treatment
        if (!authHeader || !authHeader.startsWith('Bearer ')) {
            response.status(403).json({message:"Forbidden"});
        }
        const accessToken = authHeader.split(" ")[1];
        const user = await accountService.verify(accessToken, dependencies);

        //output
        next();
    }catch(err){
        //Token Verification Failed
        next(new Error(`Verification Failed ${err.message}`));
        }
    };

//... code as before

    return {
        createAccount,
        getAccount,
        listAccounts,
        updateAccount,
        authenticateAccount,
        addFavourite,
        getFavourites,
        removeFavourite,
        verifyToken  //ADD THIS
    };
~~~



+ Put the Verification controller on the route.

~~~javascript
~~~





## Test the MovieDB API

Now test that access to the */api/movies* requires JWT token.

+ As before, authenticate a known user in the database. This time, copy the JWT Token returned from the API:

![Get JWT Token](./img/user3.png)

+ Try to access */api/movies* without including the token - it will return a status 401 - unauthorised. 

![No/invalid JWT Token](./img/user5.png)

+ Now, in Postman, add a ``authorization`` header to the request and paste in the JWT token copied in the previous step. You should now see all existing posts returned.

![No/invalid JWT Token](./img/user7.png)