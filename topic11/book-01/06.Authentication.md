# React - Authentication Context

Your API uses JSON Web Tokens(JWT) to authenticate. We now need to create an *authContext.js* to store and use JWT tokens.



### Authentication Context

+ **IN THE REACT APP**,  create a new folder called /***src/contexts*** and create a file called **authContext.jsx**  with the following content:   

```javascript
import React, { useState, createContext } from "react";
import { login, signup } from "../api";

export const AuthContext = createContext(null);

const AuthContextProvider = (props) => {
  const existingToken = localStorage.getItem("token");
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [authToken, setAuthToken] = useState(existingToken);
  const [email, setEmail] = useState("");

  //Function to put JWT token in local storage.
  const setToken = (data) => {
    localStorage.setItem("token", data);
    setAuthToken(data);
  }

  const authenticate = async (email, password) => {
    const result = await login(email, password);
    if (result.token) {
      setToken(result.token)
      setIsAuthenticated(true);
      setEmail(email);
    }
  };

  const register = async (email, password, firstName, lastName) => {
    const result = await signup(email, password, firstName,lastName);
    console.log(result.code);
    return (result.code == 201) ? true : false;
  };

  const signout = () => {
    setTimeout(() => setIsAuthenticated(false), 100);
  }

  return (
    <AuthContext.Provider
      value={{
        isAuthenticated,
        authenticate,
        register,
        signout,
        email
      }}
    >
      {props.children}
    </AuthContext.Provider>
  );
};

export default AuthContextProvider;
```

You will use this context to manage and keep track of the user authentication. Notice that it contains *isAuthenticated, userName*, and *authToken* state variables. It also provides an *authenticate()* and *register()* functions that use the API to authenticate and register users.
The ``localStorage.setItem("token", data);`` statement is used to store the JWT token in the browsers local storage. 

## Login Page
You will now update the basic React login page to use the authentication Context in the React App.

+ In */src/pages* folder, locate the file *loginPage.js* and replace with the following:

~~~javascript
import React, { useContext, useState } from "react";
import { Navigate } from "react-router-dom";
import { AuthContext } from '../contexts/authContext';
import { Link } from "react-router-dom";

const LoginPage = props => {
  const context = useContext(AuthContext)
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  const login = () => {
    context.authenticate(email, password);
  };

  // Set 'from' to path where browser is redirected after a successful login.
  // Either / or the protected path user tried to access.
 // const { from } = props.location.state || { from: { pathname: "/" } };

  if (context.isAuthenticated === true) {
    return <Navigate to={"./home"} />;
  }
  return (
    <>
      <h2>Login page</h2>
      <p>You must log in to view the protected pages </p>
      <input id="email" placeholder="email" onChange={e => {
        setEmail(e.target.value);
      }}></input><br />
      <input id="password" type="password" placeholder="password" onChange={e => {
        setPassword(e.target.value);
      }}></input><br />
      {/* Login web form  */}
      <button onClick={login}>Log in</button>
      <p>Not Registered?
      <Link to="/signup">Sign Up!</Link></p>
    </>
  );
};

export default LoginPage;
~~~
This page provides the input fields for user name and password and uses the auth context to authenticate the user. 

+ Open */src/index.js*. Underneath the ``<Link to"/">Sign Up</Link>`` statement, enter another link to the SignUp page: 

  ~~~javascript
            <br />
            <Link to="/login">Log In</Link>
  ~~~


+ Now test the Log In feature by clicking on the Login link. **Remember you need to use a email and password that's in the DB. Use the email/password you used in the last step**
  If successful, the Login will redirect to the Home page. 

## Private Routes

We will only allow authenticated users access Movie Details. We need to create a ``<PrivateRoute >`` element to  force authentication using the login page.

+ In the */src* folder, create a new file called ***privateRoute.jsx.*** Add the following content:

~~~javascript
import React, { useContext } from "react";
import { Navigate } from "react-router-dom";
import { AuthContext } from './contexts/authContext'

const PrivateRoute = ({ children }) => {
  const context = useContext(AuthContext)
  return context.isAuthenticated ? children : <Navigate to="/login" />;
};

export default PrivateRoute;
~~~

This component uses the AuthContext to check if a user is authenticated. If not, a ``<Naviagate >`` element configured and the login page is returned. If not, the child element of the <PrivateRoute>is returned

+ Open /src/indedx.jsx and replace ``<Route path="/movies/:id" element={<MoviePage>} />`` statement with the following:

  ~~~
   <Route path="/movies/:id" element={
                <PrivateRoute>
                  <MoviePage />
                </PrivateRoute>}
   />
  ~~~

+ Now try to click on a movie to access the details. You will be directed to the login page. Authenticate using the login page and you will now be able to access the Movie Details. 

## Personalised Authentication Header

It would be nice to show the authentication status in the app to show if someone is logged in or not. To do this, we will add an Authentication header to the app that will display the email address of the user that is currently logged in:

+ In the */src* folder, create a file called authHeader.jsx and add the following content:

~~~javascript
import React, { useContext } from "react";
import { withRouter } from "react-router-dom";
import { AuthContext } from "./authContext";

const BaseAuthHeader = (props) => {
  const context = useContext(AuthContext);
  const { history } = props;

  return context.isAuthenticated ? (
    <p>
      Welcome {context.email}! <button onClick={() => context.signout()}>Sign out</button>
    </p>
  ) : (
    <p>
      You are not logged in{" "}
      <button onClick={() => history.push("/login")}>Login</button>
    </p>
  );
};

export default withRouter(BaseAuthHeader);
~~~

This component will display a simple "Welcome" message only if the user has authenticated. Otherwise, it displays a link to the Login Page.

## Update index.jsx

Finally, update the index.jsx to use the login page, authentication context, and private component:

+ In the /src/index.jsx, import the authHeader component

  ~~~javascript
  import AuthHeader from "./authHeader";
  ~~~

+ In the same file, add the component just inside the <AuthContextProvider> scope and before the home <Link>

  ```javascript
  ...
  <AuthContextProvider>
      <AuthHeader />  // DD THIS LINE
  	<Link to="/">Home</Link>
  ...
  ```

  

## Test It!

+ Now, open the react app in a browser using *http//:localhost:3000* and click on a *movies* link. You should see the updated login page with username and password fields. Enter a known user name and password (user1 and test1) and the app should authenticate using the API and get a JWT token. You should also be able to access all protected routes  on the React App (Movies and Profile).  
<img src="./img/image-20230420003742811.png" alt="image-20230420003742811" style="zoom:50%;" />   
The following screen shot shows the app after authentication. In developer tools, you can see the JWT token in the browsers local storage.  
<img src="./img/image-20230420003943472.png" alt="image-20230420003943472" style="zoom:50%;" />

## Commit it!
Commit your changes
~~~bash
git add -A
git commit -m "Update Authentication Context"
~~~